---
title: "Data cleaning"
author: "Katrina Keegan"
date: "10/13/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

```{r, warning=FALSE, message=FALSE}
raw_nexta_aug_8_aug_13 <- read_csv("raw_data_csv/nexta_aug_8_aug_13.csv")
raw_nexta_aug_14_aug_23 <- read_csv("raw_data_csv/nexta_aug_14_aug_23.csv")
raw_nexta_aug_24_aug_31 <- read_csv("raw_data_csv/nexta_aug_24_aug_31.csv")
raw_nexta_sep_1_sep_13 <- read_csv("raw_data_csv/nexta_sep_1_sep_13.csv")
raw_nexta_sep_14_sep_30 <- read_csv("raw_data_csv/nexta_sep_14_sep_30.csv")

raw_tutby <- read_csv("raw_data_csv/tutby_official_raw.csv")

raw_nexta_tv <- read_csv("raw_data_csv/raw_nexta_tv.csv")

raw_luxta <- read_csv("raw_data_csv/luxta.csv")

raw_belamova <- read_csv("raw_data_csv/belamova.csv")

raw_mkbelarus <- read_csv("raw_data_csv/mkbelarus.csv")

raw_nashaniva <- read_csv("raw_data_csv/nashaniva.csv")

raw_onliner <- read_csv("raw_data_csv/onliner.csv")

raw_euroradio <- read_csv("raw_data_csv/euroradio.csv")

raw_motolkohelp <- read_csv("raw_data_csv/motolkohelp.csv")

raw_kyky <- read_csv("raw_data_csv/kyky.csv")
```

```{r}
#A function that takes data scraped from telegram and converted to csv through https://json-csv.com/
#And outputs just the columns with network info (links and forwarded from), with NAs in both removed

clean_to_network_cols <- function(data) {
  data %>%
    select(messages__text__href, messages__forwarded_from) %>%
  rename(link = messages__text__href, forwarded = messages__forwarded_from) %>%
  filter(!is.na(link) | !is.na(forwarded)) 
}

#Perform above function for nexta data
nexta_aug_8_aug_13_clean1 <- clean_to_network_cols(raw_nexta_aug_8_aug_13)

nexta_aug_14_aug_23_clean1 <- clean_to_network_cols(raw_nexta_aug_14_aug_23)

nexta_aug_24_aug_31_clean1 <- clean_to_network_cols(raw_nexta_aug_24_aug_31)

nexta_sep_1_sep_13_clean1 <- clean_to_network_cols(raw_nexta_sep_1_sep_13)

nexta_sep_14_sep_30_clean1 <- clean_to_network_cols(raw_nexta_sep_14_sep_30)

#Join nexta data into one dataset
nexta_clean1 <- bind_rows(nexta_aug_8_aug_13_clean1,
                      nexta_aug_14_aug_23_clean1,
                      nexta_aug_24_aug_31_clean1,
                      nexta_sep_1_sep_13_clean1,
                      nexta_sep_14_sep_30_clean1)
  
```

```{r}
#Change telegram links into forwarded format

change_link_to_name <- function(data) {
data %>%
  mutate(network =
         case_when(!is.na(forwarded) ~ forwarded,
                   grepl("BlackBookBelarus", link) ~"Черная книга Беларуси",
                   grepl("joinchat/FOFVqhyzx5Gd3B", link) ~"Neighborhood group",
                   grepl("luxta_tv", link) ~"LUXTA",
                   grepl("minsk_eastern_district_107_chat", link) ~"Neighborhood group",
                   grepl("nexta_live", link) ~"NEXTA Live",
                   grepl("nexta_tv", link) ~"NEXTA",
                   grepl("bel_girls", link) ~"GIRL POWER BELARUS",
                   grepl("BelarusTelegram", link) ~"Беларуский Телеграм",
                   grepl("Belatp", link) ~"Типичная Беларусь",
                   grepl("bysol", link) ~"Фонд солидарности BYSOL",
                   grepl("cpartisans", link) ~"Кибер-Партизаны",
                   grepl("euroradio", link) ~"Euroradio",
                   grepl("grankovski", link) ~"Neighborhood group",
                   grepl("honestpeople_by", link) ~"Честные люди",
                   grepl("joinchat/AAAAAEjffyoi9hgp9kVhTA", link) ~"МАЯ КРАІНА БЕЛАРУСЬ",
                   grepl("joinchat/AAAAAEklfX7sPNSO8QXhJw", link) ~"Усы Лукашенко",
                   grepl("joinchat/AAAAAFPezXkJRKSNTyAm7w", link) ~"Типичная Беларусь",
                   grepl("joinchat/H6JljhkJIaEk321KqY6YNA", link) ~"Neighborhood group",
                   grepl("kraina97", link) ~"97%",
                   grepl("kupalovskiy95", link) ~"Neighborhood group",
                   grepl("lifeyt", link) ~"ЖЮ",
                   grepl("MKBelbot", link) ~"МАЯ КРАІНА БЕЛАРУСЬ",
                   grepl("motolkohelp", link) ~"#МотолькоПомоги этому городишко от 3% избавиться",
                   grepl("nashaniva", link) ~"Наша Нiва",
                   grepl("okrug99minsk", link) ~"Neighborhood group",
                   grepl("otzyv_lagunova", link) ~"Neighborhood group",
                   grepl("pulpervoi", link) ~"Светлана Тихановская",
                   grepl("recall_deputy_lenchevskaya", link) ~"Neighborhood group",
                   grepl("recall_deputy_starovoitova", link) ~"Neighborhood group",
                   grepl("rh_by", link) ~"Рэгіянальная газета",
                   grepl("rian_ru", link) ~"РИА Новости",
                   grepl("stachkom", link) ~"Стачком ОАО Беларуськалий",
                   grepl("stop_dick", link) ~"Stop Dick",
                   grepl("stop_dumbadze", link) ~"Neighborhood group",
                   grepl("thisminsk", link) ~"Это Минск, детка!",
                   grepl("tutby_official", link) ~"TUT.BY новости",
                   grepl("zhodino2020", link) ~"Координация помощи в Жодино",
                   grepl("ATN_BTRC", link) ~"ATN_NEWS",
                   grepl("bajby", link) ~"БАЖ / BAJ",
                   grepl("dimsmirnov175", link) ~"Пул N3",
                   grepl("minzdravbelarus", link) ~"Официальный Минздрав",
                   grepl("nvonlineby", link) ~"Народная Воля (газета-сайт)",
                   grepl("radiosvaboda", link) ~"Радыё Свабода — Беларусь",
                   grepl("rbc_news", link) ~"РБК",
                   grepl("robabayan", link) ~"Роман Бабаян",
                   grepl("studenty2020", link) ~"Студэнцкая ініцыятыўная група",
                   grepl("tass_agency", link) ~"ТАСС",
                   grepl("viktarbabarykaofficial", link) ~"Виктор Бабарико — официальный канал",
                   grepl("vladimirlegoyda", link) ~"Владимир Легойда",
                   grepl("stop_gaiduk", link) ~"Neighborhood group",
                   grepl("lukanomika", link) ~"ЭКАНОМІКА",
                   grepl("belsat", link) ~"Белсат",
                   grepl("bazabazon", link) ~"Baza",
                   grepl("belarus_blacklist_bot", link) ~"Черная книга Беларуси",
                   grepl("durov", link) ~"Durov's Channel",
                   grepl("tsikhanouskaya", link) ~"Светлана Тихановская",
                   grepl("jivaiagazeta", link) ~"Пенсионеры 97%. Инфо",
                   grepl("narod97", link) ~"Чат 97%",
                   grepl("pul_1", link) ~"Пул Первого",
                   grepl("belamova", link) ~"Беларусь головного мозга",
                   grepl("bnkbel", link) ~"Баста!",
                   grepl("gomeltoday", link) ~"Сильные Новости - gomel.today",
                   grepl("UsyLukashenko", link) ~"Усы Лукашенко",
                   grepl("RealnaiaBelarus", link) ~"Реальная Беларусь",
                   grepl("joinchat/AAAAAEFpAvewJ_3iThy5lA", link) ~"Горячие Новости",
                   grepl("sadmika", link) ~"Грустный Коленька",
                   grepl("MikolaDziadok", link) ~"MIKOLA",
                   grepl("worldprotest", link) ~"Протесты в мире",
                   grepl("vybary", link) ~"Выборы. Беларусь",
                   grepl("belarus_economy", link) ~"Экономика Беларуси",
                   grepl("belarusian_history", link) ~"Belarus history",
                   grepl("belarus_lite", link) ~"Пятая колонка",
                   grepl("tginfo", link) ~"Telegram Info",
                   grepl("mkbelarus", link) ~"МАЯ КРАІНА БЕЛАРУСЬ",
                   grepl("listovki_97", link) ~"Листовки 97%",
                   grepl("palchys", link) ~"PALCHYS",
                   grepl("latushka", link) ~"Павел Латушко | Pavel Latushka",
                   grepl("iSANS_Belarus", link) ~"iSANS Беларусь",
                   grepl("BlackBookBrest", link) ~"Черная книга local",
                   grepl("BlackBookVitebsk", link) ~"Черная книга local",
                   grepl("BlackBookGomel", link) ~"Черная книга local",
                   grepl("BlackBookGrodno", link) ~"Черная книга local",
                   grepl("BlackBookMogilev", link) ~"Черная книга local",
                   grepl("CyberPartisan", link) ~"Кибер Партизаны",
                   grepl("bychangenews", link) ~"ByChange",
                   grepl("onlinerby", link) ~"Onliner",
                   grepl("naukaforpeople", link) ~"Забавная Наука",
                   grepl("prirodaforpeople", link) ~"Жэсточайшая Природа",
                   grepl("twarforpeople", link) ~"Жэсточайшие Твари",
                   grepl("cyberpartisan", link) ~"Кибер Партизаны",
                   grepl("pramenby", link) ~"Прамень",
                   grepl("elehtarat", link) ~"Элехтарат",
                   grepl("joinchat/Iv257x0g4SFPQBYeW-pdow", link) ~"Neighborhood group",
                   grepl("joinchat/AAAAAEklfX5GcSBexFNnKA", link) ~"Усы Лукашенко",
                   grepl("joinchat/AAAAAEklfX5GcSBexFNnKA", link) ~"Усы Лукашенко",
                   grepl("viasna96", link) ~"Вясна / Правы чалавека ў Беларусі",
                   grepl("studentyBY", link) ~"отчислено",
                   grepl("s_bdtu", link) ~"Салідарны БДТУ",
                   grepl("rada_vision", link) ~"Координационный совет",
                   grepl("pressmvd", link) ~"Пресс-секретарь МВД Беларуси",
                   grepl("pressballby", link) ~"Спорт Беларуси — Прессбол",
                   grepl("poezdBY", link) ~"Молодежный поезд",
                   grepl("peaceful_bsuir", link) ~"Мирный БГУИР",
                   grepl("minskoemetro", link) ~"Минский метрополитен",
                   grepl("kyky_org", link) ~"Кулуары KYKY",
                   grepl("krumkachy", link) ~"Krumkachy",
                   grepl("klaskouski", link) ~"Klaskouski",
                   grepl("intexpress", link) ~"Интекс-Пресс Барановичи",
                   grepl("golosby_bot", link) ~"Голос",
                   grepl("eu_by", link) ~"Европейская Беларусь",
                   grepl("cvboard", link) ~"CV board: Honest people/HR Breakfast",
                   grepl("binklbinkl", link) ~"БИНОКЛЬ",
                   grepl("belxalat", link) ~"БЕЛЫЕ ХАЛАТЫ",
                   grepl("belteanews", link) ~"Чай з малинавым варэннем",
                   grepl("belarusseichas", link) ~"Беларусь Сейчас",
                   grepl("belarusin", link) ~"ЧП Беларусь",
                   grepl("mbkhmedia", link) ~"МБХ медиа",
                   grepl("khliabets", link) ~"Khliabets",
                   grepl("MSTBELARUS", link) ~"Пресс-служба Министерства спорта и туризма",
                   grepl("LptSM1dPAC3ro5_GRi8E1Q", link) ~"Каментатарская",
                   grepl("hrydzinphoto", link) ~"Hrydzin Phototography",
                   grepl("novaya_pishet", link) ~"Новая газета",
                   grepl("aavst55", link) ~"aavst",
                   grepl("UnileverRussiaNews", link) ~"Unilever в России: о бизнесе, брендах и людях",
                   grepl("menskdoldrums", link) ~"Менская хандра",
                   grepl("tabakerka_by", link) ~"Беларусь бастует!",
                   grepl("polotsk_novopolotsk", link) ~"Полоцк - Новополоцк Беларусь",
                   grepl("rt_russian", link) ~"RT на русском",
                   grepl("terroristybelarusi", link) ~"Каратели Беларуси - имена, адреса, родственники",
                   grepl("praludzej", link) ~"Пра людзей. Беларусь",
                   grepl("progomel", link) ~"Neighborhood group",
                   grepl("mediazona_by", link) ~"Медиазона. Беларусь",
                   grepl("molovTG", link) ~"Молодечно HOME",
                   grepl("the_village_me", link) ~"The Village Беларусь",
                   grepl("vybory_smotri", link) ~"Выборы видишь? | TUT.BY Политика",
                   grepl("spadczyna", link) ~"Спадчына",
                   grepl("skgovby", link) ~"Следственный комитет Беларуси",
                   grepl("horadnia", link) ~"Haradzenski",
                   grepl("hrodnalife", link) ~"Hrodna.life",
                   grepl("vitebsk97pro", link) ~"Витебск 97%",
                   grepl("polotsk_i_novopolotsk", link) ~"Полоцк и Новополоцк",
                   grepl("ntvnews", link) ~"НТВ",
                   grepl("lebiadok", link) ~"Lebiadok",
                   grepl("diarius_corporatum", link) ~"Дыярыуш карпаранцкі",
                   grepl("breakingmash", link) ~"Mash",
                   grepl("minsk_new", link) ~"Минск: какой народец - такой и городишко",
                   grepl("iznanka_news", link) ~"Изнанка 18+ | Украина",
                   grepl("spiski_okrestina", link) ~"Списки Задержанных",
                   grepl("real_kyiv", link) ~"Real Kyiv",
                   grepl("meduzalive", link) ~"Медуза — LIVE",
                   grepl("codaru", link) ~"CodaRU",
                   grepl("belarus_mythology", link) ~"Мифология Беларуси",
                   grepl("protest_by", link) ~"Честные новости",
                   grepl("koko_by", link) ~"Мерзкий Кокобай", 
                   grepl("brestgazetatelegram", link) ~"Брестская газета: новости - 2020",
                   grepl("BelGram", link) ~ "Беларусь Телеграм Чат",
                   grepl("suh97pro", link) ~"Neighborhood group",
                   grepl("MayakMinsk", link) ~"Neighborhood group", 
                   grepl("sovbelorussia", link) ~"Советская Белоруссия",
                   grepl("naviny_by", link) ~"Naviny.by",
                   grepl("joinchat/BRXqnBthP4Ow7jxmEQK8Dw", link) ~ "Neighborhood group",
                   grepl("joinchat/FVRJK1JydYL_NcAjzr1eXQ", link) ~ "Neighborhood group",
                   grepl("Len95okrug", link) ~ "Neighborhood group",
                   grepl("brestcomment", link) ~"Брест - обсуждаем новости города", 
                   grepl("grodno015by", link) ~ "Сайт Гродно 015.BY", 
                   grepl("gazetaby", link) ~"Салідарнасць – главные новости Беларуси",
                   grepl("tribuna_by", link) ~"Tribuna.com Беларусь", 
                   grepl("Bell_tech", link) ~"The Bell Tech",
                   grepl("gpkgovby", link) ~"Пограничный комитет Беларуси",
                   grepl("TheCitizenBelarus", link) ~"Гражданин",
                   grepl("telegrambelarus", link) ~"Telegram Беларусь",
                   grepl("harbatsevich", link) ~"HARBACEVIČ",
                   grepl("zaslavl_new", link) ~"Заславский чат активистов",
                   grepl("vottaktv", link) ~"Vot Tak TV",
                   grepl("CatalogTelegram", link) ~"Каталог Telegram", 
                   grepl("bnr100by", link) ~"Каманда БНР100",
                   grepl("symbalby", link) ~"SYMBAL.BY",
                   grepl("joinchat/AAAAAEwwDXiIvnT0OwM8xQ", link) ~"Будни Беларуси",
                    grepl("krasnyj_bor", link) ~"Neighborhood group"
                   )
         )
}

nexta_clean2 <- change_link_to_name(nexta_clean1)
     
```


```{r}
#See Nexta's connections!
count_connections <- function(data) {
data %>%
  group_by(network) %>%
  summarize(count = n(), .groups = "drop") %>%
  arrange(desc(count))
}

nexta_connections <- count_connections(nexta_clean2) %>%
  mutate(source = "NEXTA Live") %>%
  filter(source != network)
```

```{r}
#Now doing the rest of the outlets
tutby_clean1 <- clean_to_network_cols(raw_tutby)
tutby_clean2 <- change_link_to_name(tutby_clean1)
tutby_connections <- count_connections(tutby_clean2)%>%
  mutate(source = "TUT.BY новости") %>%
  filter(source != network)

nexta_tv_clean1 <- clean_to_network_cols(raw_nexta_tv)
nexta_tv_clean2 <- change_link_to_name(nexta_tv_clean1)
nexta_tv_connections <- count_connections(nexta_tv_clean2) %>%
  mutate(source = "NEXTA") %>%
  filter(source != network)

luxta_clean1 <- clean_to_network_cols(raw_luxta)
luxta_clean2 <- change_link_to_name(luxta_clean1)
luxta_connections <- count_connections(luxta_clean2) %>%
  mutate(source = "LUXTA") %>%
  filter(source != network)

belamova_clean1 <- clean_to_network_cols(raw_belamova)
belamova_clean2 <- change_link_to_name(belamova_clean1)
belamova_connections <- count_connections(belamova_clean2) %>%
  mutate(source = "Беларусь головного мозга") %>%
  filter(source != network)

mkbelarus_clean1 <- clean_to_network_cols(raw_mkbelarus)
mkbelarus_clean2 <- change_link_to_name(mkbelarus_clean1)
mkbelarus_connections <- count_connections(mkbelarus_clean2) %>%
  mutate(source = "МАЯ КРАІНА БЕЛАРУСЬ") %>%
  filter(source != network) %>%
  filter(!is.na(network))

nashaniva_clean1 <- clean_to_network_cols(raw_nashaniva)
nashaniva_clean2 <- change_link_to_name(nashaniva_clean1)
nashaniva_connections <- count_connections(nashaniva_clean2) %>%
  mutate(source = "Наша Нiва") %>%
  filter(source != network) %>%
  filter(!is.na(network))

onliner_clean1 <- clean_to_network_cols(raw_onliner)
onliner_clean2 <- change_link_to_name(onliner_clean1)
onliner_connections <- count_connections(onliner_clean2) %>%
  mutate(source = "Onliner") %>%
  filter(source != network) %>%
  filter(!is.na(network))

euroradio_clean1 <- clean_to_network_cols(raw_euroradio)
euroradio_clean2 <- change_link_to_name(euroradio_clean1)
euroradio_connections <- count_connections(euroradio_clean2) %>%
  mutate(source = "Euroradio") %>%
  filter(source != network) %>%
  filter(!is.na(network))

motolkohelp_clean1 <- clean_to_network_cols(raw_motolkohelp)
motolkohelp_clean2 <- change_link_to_name(motolkohelp_clean1)
motolkohelp_connections <- count_connections(motolkohelp_clean2) %>%
  mutate(source = "#МотолькоПомоги этому городишко от 3% избавиться") %>%
  filter(source != network) %>%
  filter(!is.na(network))

kyky_clean1 <- clean_to_network_cols(raw_kyky)
kyky_clean2 <- change_link_to_name(kyky_clean1)
kyky_connections <- count_connections(kyky_clean2) %>%
  mutate(source = "Кулуары KYKY") %>%
  filter(source != network) %>%
  filter(!is.na(network))

radiosvaboda_clean2 <- read_csv("raw_data_csv/radiosvaboda.csv") %>%
  clean_to_network_cols() %>%
  change_link_to_name()

```


```{r}
create_connections <- function(data, name) {
  read_csv(data, col_types = cols(
  .default = col_character(),
  id = col_double(),
  messages__id = col_double(),
  messages__date = col_datetime(format = ""),
  messages__edited = col_datetime(format = ""),
  messages__from_id = col_double(),
  messages__duration_seconds = col_double(),
  messages__width = col_double(),
  messages__height = col_double(),
  messages__reply_to_message_id = col_double()
)) %>%
    clean_to_network_cols() %>%
    change_link_to_name() %>%
    count_connections() %>%
    mutate(source = name) %>%
    filter(source != network) %>%
    filter(!is.na(network))
}

kyky_connections <- create_connections("raw_data_csv/kyky.csv", "Кулуары KYKY")

belsat_connections <- create_connections("raw_data_csv/belsat.csv", "Белсат")

radiosvaboda_connections <- create_connections("raw_data_csv/radiosvaboda.csv", "Радыё Свабода — Беларусь")

usylukashenko_connections <- create_connections("raw_data_csv/usylukashenko.csv", "Усы Лукашенко")

tsikhanouskaya_connections <- create_connections("raw_data_csv/tsikhanouskaya.csv", "Светлана Тихановская")

blackbookbelarus_connections <- create_connections("raw_data_csv/blackbookbelarus.csv", "Черная книга Беларуси")

belteanews_connections <- create_connections("raw_data_csv/belteanews.csv", "Чай з малинавым варэннем")

tribuna_by_connections <- create_connections("raw_data_csv/tribuna_by.csv", "Tribuna.com Беларусь")

studenty_by_connections <- create_connections("raw_data_csv/studenty_by.csv", "отчислено")

pressmvd_connections <- create_connections("raw_data_csv/pressmvd.csv", "Пресс-секретарь МВД Беларуси")

mc_maxim_connections <- create_connections("raw_data_csv/mc_maxim.csv", "Работаем с Пушкиным!")

viasna96_connections <- create_connections("raw_data_csv/viasna96.csv", "Вясна / Правы чалавека ў Беларусі")

bajby_connections <- create_connections("raw_data_csv/bajby.csv", "БАЖ / BAJ")

```


```{r}
big_network <- bind_rows(nexta_connections, 
                         tutby_connections,
                         nexta_tv_connections,
                         belamova_connections,
                         mkbelarus_connections,
                         nashaniva_connections,
                         onliner_connections,
                         euroradio_connections,
                         motolkohelp_connections,
                         kyky_connections,
                         belsat_connections,
                         radiosvaboda_connections,
                         usylukashenko_connections,
                         tsikhanouskaya_connections,
                         blackbookbelarus_connections,
                         belteanews_connections,
                         tribuna_by_connections,
                         studenty_by_connections,
                         pressmvd_connections,
                         mc_maxim_connections,
                         viasna96_connections,
                         bajby_connections)

big_network_greater20 <- big_network %>%
  filter(count > 9)

most_connected <- big_network %>%
  group_by(network) %>%
  summarize(total_links = sum(count), .groups = "drop") %>%
  arrange(desc(total_links)) %>%
  slice(1:21) %>%
  filter(!is.na(network))

most_connected %>%
  ggplot(aes(x = total_links, y = fct_reorder(network, total_links))) +
    geom_col()
```

